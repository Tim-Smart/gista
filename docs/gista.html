<!DOCTYPE html>

<html>
<head>
  <title>The Node Gist CLI Tool</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
    <ul class="sections">
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap for-h1">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <h1>The Node Gist CLI Tool</h1>

            </div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>A handy little tool that allows you to use Gist like a unix pro.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>Client   = require(<span class="string">'node-gist'</span>).Client
nopt     = require <span class="string">'nopt'</span>
path     = require <span class="string">'path'</span>
url      = require <span class="string">'url'</span>
tty      = require(<span class="string">'tty'</span>).isatty(process.stdout.fd)
fs       = require <span class="string">'fs'</span>
async    = require(<span class="string">'async-array'</span>).async
read     = require <span class="string">'read'</span>
{ exec } = require <span class="string">'child_process'</span>

client   = <span class="literal">null</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>HELP</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>help = <span class="string">"""
Create a Gist from a file or stdin using node-gist.

gista -pd "My cool gist" [file.ext]

Options:
  -f, --fetch     Fetch a gist by id or url
  -e, --edit      Edit a gist by id or url
  -*, --star      Star a gist by id or url
  -x, --delete    Delete a gist by id or url
  -p, --public    Create a public gist
  -n, --name      Set the file name
  -d, --desc      Add a description
  -t, --type      Set the file extension
  -a, --token     Manually set the oauth token
  -u, --user      Manually set Github username. If --password is
                  not provided, a password prompt will appear
      --password  Manually set Github password
      --gentoken  Generate a token from provided token/credentials
      --tty       Force tty mode for output formatting
  -v, --verbose   When reading from stdin, echo input back to stdout
  -h, --help      You looking at it

Getting Started:
  1. Get a token (gista doesn't store your password anywhere)
    gista --user github-user --gentoken
  2. Export token somewhere to $GISTA_TOKEN
    echo "export GISTA_TOKEN=xxx" &gt;&gt; ~/.bashrc
  3. Restart your shell and start gist'n.
    echo "Hello world." | gista -n hello-world.txt

"""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>Option parsing is done with <code>nopt</code> - a handy library sculpted by
Isaac Schlueter</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>known_opts =
  public:   Boolean
  fetch:    String
  edit:     String
  star:     String
  <span class="keyword">delete</span>:   String
  name:     String
  desc:     String
  type:     String
  token:    String
  gentoken: Boolean
  password: String
  user:     String
  tty:      Boolean
  verbose:  Boolean
  help:     Boolean

short_opts =
  f: <span class="string">'--fetch'</span>
  e: <span class="string">'--edit'</span>
  <span class="string">'*'</span>: <span class="string">'--star'</span>
  x: <span class="string">'--delete'</span>
  p: [<span class="string">'--public'</span>, <span class="string">'true'</span>]
  n: <span class="string">'--name'</span>
  d: <span class="string">'--desc'</span>
  t: <span class="string">'--type'</span>
  a: <span class="string">'--token'</span>
  u: <span class="string">'--user'</span>
  v: <span class="string">'--verbose'</span>
  h: <span class="string">'--help'</span>

options = nopt known_opts, short_opts

options.tty = tty <span class="keyword">unless</span> options.tty?</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>read options</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>read_opts =
  prompt: <span class="string">'Password: '</span>
  silent: <span class="literal">yes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>Show the help?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> options.help
  console.log help
  <span class="keyword">return</span> process.exit()</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>Ensure the string is an gist id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">ensureGistId</span></span> = (id) -&gt;
  id  = (url.parse id).pathname
  id  = id.split(<span class="string">'/'</span>).pop()
  <span class="keyword">return</span> id</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>Fetch mode? Fetch mode precedes gist creation.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="keyword">if</span> options.fetch
  client = <span class="keyword">new</span> Client
  <span class="keyword">return</span> client.get <span class="string">"/<span class="subst">#{ensureGistId(options.fetch)}</span>"</span>, (error, gist) -&gt;
    <span class="keyword">throw</span> error <span class="keyword">if</span> error

    <span class="keyword">try</span>
      files = Object.keys(gist.files)
    <span class="keyword">catch</span> error
      <span class="keyword">throw</span> <span class="keyword">new</span> Error(<span class="string">'Gist not found'</span>)

    multiple = files.length &gt; <span class="number">1</span>

    <span class="keyword">unless</span> multiple
      <span class="keyword">return</span> process.stdout.write gist.files[files[<span class="number">0</span>]].content

    ret = []
    <span class="keyword">for</span> file <span class="keyword">in</span> files
      ret.push(
        [ file
        , <span class="string">'\n'</span>
        , <span class="keyword">new</span> Array(file.length + <span class="number">1</span>).join(<span class="string">'='</span>)
        , <span class="string">'\n\n'</span>
        , gist.files[file].content
        ]
        .join(<span class="string">''</span>)
      )

    console.log ret.join(<span class="string">'\r\n'</span>)

files = options.argv.remain</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>Are we generating a oauth token?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>is_gentoken = options.gentoken <span class="keyword">is</span> <span class="literal">yes</span></pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-10">&#182;</a>
              </div>
              <p>Are we reading from stdin, or reading from a list of files?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>is_stdin = options.argv.remain.length <span class="keyword">is</span> <span class="number">0</span></pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-11">&#182;</a>
              </div>
              <p>We need to exhaust all the cases where the github user and token
could be stored.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">loadConfig</span></span> = (callback) -&gt;
  ask_password     = !!options.user <span class="keyword">and</span> !options.token

  options.user     = process.env.GITHUB_USER     <span class="keyword">unless</span> options.user
  options.password = process.env.GITHUB_PASSWORD <span class="keyword">unless</span> options.password
  options.token    = process.env.GISTA_TOKEN     <span class="keyword">unless</span> options.token

  <span class="function"><span class="title">gotPassword</span></span> = (error, password) -&gt;
    <span class="keyword">throw</span> error <span class="keyword">if</span> error

    options.password  = password

    <span class="keyword">if</span> options.token
      options.user      = <span class="literal">null</span>
      options.password  = <span class="literal">null</span>
      <span class="keyword">return</span> callback()

    task = async []

    task.push <span class="string">'user'</span>     <span class="keyword">unless</span> options.user
    task.push <span class="string">'password'</span> <span class="keyword">unless</span> options.password

    task
      .forEach (item, i, next) -&gt;
        exec <span class="string">"git config --global github.<span class="subst">#{item}</span>"</span>, (error, stdout) -&gt;
          <span class="keyword">return</span> next() <span class="keyword">if</span> error
          options[item] = stdout.trim()
          next()
      .exec (error, results) -&gt;
        has_userpass  = (options.user <span class="keyword">and</span> options.password) <span class="keyword">isnt</span> <span class="literal">null</span>

        <span class="keyword">unless</span> has_userpass
          options.user = options.password = <span class="literal">null</span>

        <span class="keyword">if</span> error
          <span class="keyword">return</span> callback error

        callback()</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-12">&#182;</a>
              </div>
              <p>Ask for password?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> ask_password
    options.token    = <span class="literal">null</span>
    options.password = <span class="literal">null</span>
    <span class="keyword">return</span> read(read_opts, gotPassword)

  gotPassword(<span class="literal">null</span>, options.password)</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-13">&#182;</a>
              </div>
              <p>Generate a oauth token with the already provided authorization</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">generateToken</span></span> = -&gt;</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-14">&#182;</a>
              </div>
              <p>Change the client path so we can use the more generic Github API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  client.path = <span class="string">''</span></pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-15">&#182;</a>
              </div>
              <p>The description for the token we need.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  authorization =
    scopes    : [ <span class="string">'gist'</span> ]
    note      : <span class="string">'gista CLI'</span>
    note_url  : <span class="string">'https://github.com/tim-smart/gista'</span></pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-16">&#182;</a>
              </div>
              <p>Create the token</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  client.post <span class="string">'/authorizations'</span>, authorization, (error, data) -&gt;
    <span class="keyword">throw</span> error <span class="keyword">if</span> error

    <span class="keyword">unless</span> data.token
      <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">'Token generation refused by Github.'</span>

    console.log data.token
    console.error <span class="string">"""\nFor continued use of this token by the gista cli tool, make
                     you assign it to the GISTA_TOKEN environment variable in your
                     bash profile."""</span></pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-17">&#182;</a>
              </div>
              <p>Star a gist from a given id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">starGist</span></span> = -&gt;
  client.put <span class="string">"/<span class="subst">#{ensureGistId(options.star)}</span>/star"</span>, (error) -&gt;
    <span class="keyword">throw</span> error <span class="keyword">if</span> error</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-18">&#182;</a>
              </div>
              <p>Delete a gist from a given id</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">deleteGist</span></span> = -&gt;
  client.<span class="keyword">delete</span> <span class="string">"/<span class="subst">#{ensureGistId(options.<span class="keyword">delete</span>)}</span>"</span>, (error) -&gt;
    <span class="keyword">throw</span> error <span class="keyword">if</span> error</pre></div></div>
            
        </li>
        
        
        <li id="section-19">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-19">&#182;</a>
              </div>
              <p>Collect data on stdin as it comes in, buffer it, and then pass it
on to <code>createGist</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">fromStdin</span></span> = -&gt;
  data  = <span class="string">''</span>
  first = <span class="literal">yes</span>
  process.stdin.resume()
  process.stdin.setEncoding <span class="string">'utf8'</span>
  process.stdin.<span class="literal">on</span> <span class="string">'data'</span>, (chunk) -&gt;
    <span class="keyword">if</span> options.verbose
      <span class="keyword">if</span> first
        process.stdout.write(<span class="string">"&gt; "</span>)
        first = <span class="literal">false</span>
      process.stdout.write chunk.split(<span class="string">"\n"</span>).join(<span class="string">"\n&gt; "</span>)
    data += chunk
  process.stdin.<span class="literal">on</span> <span class="string">'end'</span>, -&gt;
    process.stdout.write(<span class="string">"EOF\n"</span>) <span class="keyword">if</span> options.verbose
    createGist [name: options.name <span class="keyword">or</span> <span class="string">'stdout.txt'</span>, content: data]</pre></div></div>
            
        </li>
        
        
        <li id="section-20">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-20">&#182;</a>
              </div>
              <p>Iterate over every file and grab the contents, ready to pass
onto <code>createGist</code>.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">fromFiles</span></span> = -&gt;
  <span class="keyword">throw</span> <span class="keyword">new</span> Error <span class="string">'Over 10 files.'</span> <span class="keyword">if</span> files.length &gt; <span class="number">10</span>

  async(files)
    .map (file, i, next) -&gt;
      fs.readFile file, <span class="string">'utf8'</span>, (error, content) -&gt;
        <span class="keyword">return</span> next error <span class="keyword">if</span> error
        name = options.name || path.basename file
        next <span class="literal">null</span>, name : name, content : content
    .exec (error, results) -&gt;
      <span class="keyword">throw</span> error <span class="keyword">if</span> error
      createGist results.array()</pre></div></div>
            
        </li>
        
        
        <li id="section-21">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-21">&#182;</a>
              </div>
              <p>Now that we have all the content we need, we can now create the gist
and post back the link.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre><span class="function"><span class="title">createGist</span></span> = (files) -&gt;
  is_public = options.public

  <span class="keyword">unless</span> is_public?
    is_public = <span class="literal">no</span>

  gist =
    public : is_public
    files  : {}

  gist.description = options.desc <span class="keyword">if</span> options.desc

  type = <span class="keyword">if</span> options.type <span class="keyword">then</span> <span class="string">'.'</span> + options.type <span class="keyword">or</span> <span class="literal">null</span>

  <span class="keyword">for</span> file <span class="keyword">in</span> files
    name = file.name
    name = name + type <span class="keyword">if</span> type
    gist.files[name] =
      content : file.content

  <span class="function"><span class="title">doneGist</span></span> = (error, gist) -&gt;
    <span class="keyword">throw</span> error <span class="keyword">if</span> error
    <span class="keyword">throw</span> <span class="keyword">new</span> Error(gist.message) <span class="keyword">if</span> gist.message

    <span class="keyword">return</span> process.stdout.write gist.html_url <span class="keyword">unless</span> options.tty
    console.log gist.html_url</pre></div></div>
            
        </li>
        
        
        <li id="section-22">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-22">&#182;</a>
              </div>
              <p>Are we an edit operation?</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="keyword">if</span> options.edit
    <span class="keyword">return</span> client.patch <span class="string">"/<span class="subst">#{ensureGistId(options.edit)}</span>"</span>, gist, doneGist

  client.post <span class="string">''</span>, gist, doneGist</pre></div></div>
            
        </li>
        
        
        <li id="section-23">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-23">&#182;</a>
              </div>
              <p>Load the user and token then either load the stdin data
or parse out the files.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>loadConfig (error) -&gt;
  <span class="keyword">throw</span> error <span class="keyword">if</span> error

  client = <span class="keyword">new</span> Client
    user      : options.user
    password  : options.password
    token     : options.token

  <span class="keyword">return</span> starGist()      <span class="keyword">if</span> options.star
  <span class="keyword">return</span> deleteGist()    <span class="keyword">if</span> options.<span class="keyword">delete</span>
  <span class="keyword">return</span> generateToken() <span class="keyword">if</span> is_gentoken
  <span class="keyword">return</span> fromStdin()     <span class="keyword">if</span> is_stdin
  fromFiles()</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
